name: Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - "infrastructure/terraform/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        type: choice
        default: "dev"
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.14.0

jobs:
  determine-env:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          else
            # Auto-deploy dev on push to main
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

  apply:
    needs: determine-env
    runs-on: ubuntu-latest
    environment:
      name: ${{ needs.determine-env.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: terraform-apply-${{ needs.determine-env.outputs.environment }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: infrastructure/terraform/environments/${{ needs.determine-env.outputs.environment }}
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: infrastructure/terraform/environments/${{ needs.determine-env.outputs.environment }}
        run: |
          terraform plan \
            -var-file="${{ needs.determine-env.outputs.environment }}.tfvars" \
            -input=false \
            -out=tfplan

      - name: Show Plan
        working-directory: infrastructure/terraform/environments/${{ needs.determine-env.outputs.environment }}
        run: terraform show -no-color tfplan

      - name: Terraform Apply
        working-directory: infrastructure/terraform/environments/${{ needs.determine-env.outputs.environment }}
        run: terraform apply -input=false tfplan

      - name: Export outputs
        id: outputs
        working-directory: infrastructure/terraform/environments/${{ needs.determine-env.outputs.environment }}
        run: |
          terraform output -json > outputs.json
          cat outputs.json

      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ needs.determine-env.outputs.environment }}
          path: infrastructure/terraform/environments/${{ needs.determine-env.outputs.environment }}/outputs.json
          retention-days: 30

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ needs.determine-env.outputs.environment }}-eks \
            --region ${{ env.AWS_REGION }}

      - name: Deploy applications to Kubernetes
        run: kubectl apply -k infrastructure/kubernetes/base

      - name: Wait for deployments
        run: |
          kubectl rollout status deployment/client -n default --timeout=5m
          kubectl rollout status deployment/server -n default --timeout=5m

      - name: Verify services
        run: kubectl get svc,pods,pvc

      - name: Notify deployment success
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Deployment Successful** - ${{ needs.determine-env.outputs.environment }}\n\nInfrastructure and applications deployed successfully.`
            });
